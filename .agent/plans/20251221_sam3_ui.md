# SAM3 UI Implementation Task & Plan

## Task List

- [ ] Analyze existing code and requirements
    - [x] `src/gui/tabs/seedling_detect.py` (Current UI)
    - [x] `dev.notes/sam3_slice/inference_slice.py` (SAM3 reference)
    - [x] `src/gui/components` (Check for reusable components)
- [ ] Design System Architecture
    - [x] Define `Sam3Model` wrapper structure
    - [x] Define UI layout and interaction flow
    - [x] Define threading/process model for inference
- [x] Create Implementation Plan
- [ ] Implement SAM3 Engine Wrapper (`src/core/sam_engine.py`)
- [ ] Implement Seedling Detection UI (`src/gui/tabs/seedling_detect.py`)
    - [ ] Top Bar (Image Load, Parameters, Test Buttons) - *Extract `src/gui/components/topbar.py`*
    - [ ] Layer Management (TreeView integration)
    - [ ] Canvas/Interaction (Test Area Selection, Vector Editing)
    - [ ] Result Visualization
- [ ] Verification
    - [ ] Test SAM3 loading
    - [ ] Test Inference (Test Area & Full)
    - [ ] Test Vector Editing
    - [ ] Test Export

## Implementation Plan

### Goal
Implement a complete Seedling Detection workflow using SAM3 in the "Seedling Detection" tab. This includes image loading, parameter configuration, interactive test area selection, sliding window inference, and results management (visualization + export).

### User Review Required
> [!IMPORTANT]
> **Visualization**: Use `sam3/visualize_utils` for generating results.
> **Multiprocessing**: Use `QThread` for inference to keep UI responsive.
> **Dependency**: Requires `sam3` in `lib` and `rasterio`/`geopandas`.
> **UX**: Top bar will use a horizontal scroll layout. Model path status will be shown via a badge. Right-click cancels selection.

### Proposed Changes

#### Core Logic
##### [NEW] [sam_engine.py](file:///d:/OneDrive/Program/GitHub/EasyPlantFieldID/src/core/sam_engine.py)
- Create `Sam3Engine` class wrapping the SAM3 model.
- Implement `load_model(model_path, device, type)`.
- Implement `run_inference_slice(...)` adapting logic from `inference_slice.py`.
- Implement threading support (e.g., `Worker` signals) for progress updates.

#### GUI Components
##### [MODIFY] [map_canvas.py](file:///d:/OneDrive/Program/GitHub/EasyPlantFieldID/src/gui/components/map_canvas.py)
- Add `start_region_selection(width_meter, height_meter, callback)` to generic `MapCanvas`.
- Add internal logic to handle `MODE_REGION_SELECT`:
    - Draw a semi-transparent red rectangle following the mouse.
    - **Interaction**: Left-click to confirm, Right-click to cancel (disable default pyqtgraph menu).
    - **Return**: On click, crop the underlying raster (RGB only) and return `(bbox, crop_numpy)`.
    - **Visualization**: Add the selected bbox as temporary vector layer to TreeView.

##### [MODIFY] [seedling_detect.py](file:///d:/OneDrive/Program/GitHub/EasyPlantFieldID/src/gui/tabs/seedling_detect.py)
- **Top Bar (Scrollable)**:
    - *Refactor*: Extract reusable topbar components to `src/gui/components/topbar.py`.
    - Add "Load Image" button.
    - **Model Status**:
        - Check for model presence.
        - If missing: Show "Error Badge". on click -> Flyout "Please set model path in settings".
        - If found: Hidden.
    - **Parameters**: 
        - Prompt (default 'plant').
        - Confidence.
        - Device (Dynamic: show 'CUDA' only if `torch.cuda.is_available()`).
    - **Slice Settings**: Size, Overlap, IoU.
    - **Tools Group** (Moved to TopBar): View, Add, Move, Delete, Undo.
    - **Test/Run Group**:
        - "Select Test Area": Triggers `MapCanvas.start_region_selection`.
        - "Test Run": Runs SAM3 on the selected crop.
        - "Full Run": Runs SAM3 on the entire top raster layer.
- **Export**:
    - Add "Export" button (SHP/JSON).

### Verification Plan

#### Automated Tests
- None planned for this interactive UI feature.

#### Manual Verification
1.  **Environment Check**: Verify `lib/sam3` is loadable.
2.  **Image Loading**: Load a GeoTIFF. Check if it appears in `MapCanvas` and TreeView.
3.  **Region Selection**:
    - Click "Select Test Area".
    - Verify red rectangle follows mouse.
    - Click to set. Verify a new vector layer "Test Area" appears.
4.  **SAM3 Inference (Test)**:
    - Click "Test Run".
    - Verify progress dialog appears.
    - Verify results (points/boxes) appear as new layers.
5.  **Full Inference**:
    - Click "Run Full".
    - Verify progress bar and final results.
